- name: Patch Management - Ubuntu Security Updates Only
  hosts: all
  become: yes
  gather_facts: yes

  tasks:

    - name: Ensure system is Ubuntu
      fail:
        msg: "This playbook supports Ubuntu only."
      when: ansible_distribution != "Ubuntu"

    - name: Wait for apt lock to be released
      shell: |
        while fuser /var/lib/dpkg/lock >/dev/null 2>&1; do
          sleep 5
        done
      changed_when: false

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Fix interrupted dpkg if needed
      command: dpkg --configure -a
      changed_when: false
      failed_when: false

    # ğŸ” LIST SECURITY UPDATES
    - name: Get list of security updates
      shell: |
        apt list --upgradable 2>/dev/null | grep "$(lsb_release -cs)-security" || true
      register: security_updates
      changed_when: false
      failed_when: false

    - name: Display security update status
      debug:
        msg: >
          {% if security_updates.stdout_lines | length > 0 %}
          Security updates available:
          {{ security_updates.stdout_lines }}
          {% else %}
          No security updates available.
          {% endif %}

    # ğŸ” APPLY SECURITY UPDATES ONLY
    - name: Apply security updates only
      shell: |
        apt-get upgrade -y \
        -o Dir::Etc::sourcelist=/etc/apt/sources.list \
        -o Dir::Etc::sourceparts=/etc/apt/sources.list.d \
        -o APT::Get::List-Cleanup=0 \
        -o APT::Upgrade-Allow-New=1 \
        -o APT::Get::Only-Upgrade=true \
        -o APT::Default-Release="$(lsb_release -cs)-security"
      register: upgrade_result
      changed_when: "'upgraded' in upgrade_result.stdout or 'newly installed' in upgrade_result.stdout"
      failed_when: false

    # ğŸ”„ CHECK REBOOT
    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot if required
      reboot:
        msg: "Reboot initiated after security updates"
        reboot_timeout: 600
      when: reboot_required.stat.exists
